name: Codecov

on: [ push, pull_request, workflow_dispatch ]

jobs:
  codecov:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - name: Compiler setup
      run: sudo apt update; sudo apt install gcc-8 g++-8
    - name: Checkout Boost
      uses: actions/checkout@v2
      with:
        repository: boostorg/boost
        ref: master
        path: .dep/boost
        submodules: recursive
    - name: Setup Boost
      run: |
        cd .dep/boost
        ./bootstrap.sh
        ./b2 headers
    - name: Check
      env:
        CXX: g++-8
        CXXFLAGS: --coverage -O0 -std=c++17 -I ../.dep/boost/include
      run: |
        make -j check
        make -j time
    - name: LCOV setup
      run: |
        wget http://downloads.sourceforge.net/ltp/lcov-1.14.tar.gz
        tar xvfz lcov-1.14.tar.gz
        make -C lcov-1.14
    - name: Codecov setup
      run: |
        curl -Os https://uploader.codecov.io/latest/linux/codecov
        chmod +x codecov
    - name: Coverage
      run: |
        lcov-1.14/bin/lcov --gcov-tool gcov-8 -c -d . -o cov.info
        lcov-1.14/bin/lcov -e cov.info '*/cxon/*.hxx' -o cxon.info
        lcov-1.14/bin/lcov -l cxon.info
        ./codecov -t ${CODECOV_TOKEN} -f cxon.info
