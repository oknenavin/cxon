name: Codecov

on:
  push:
    branches:
      - develop
      - master
      - release/*
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '37 3 * * 6'

jobs:
  codecov:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Checkout Boost
      uses: actions/checkout@v3
      with:
        repository: boostorg/boost
        ref: boost-1.81.0
        path: .dep/boost
    - name: Setup Boost
      run: |
        cd .dep/boost
        git submodule update --init tools/build
        git submodule update --init tools/boostdep
        git submodule update --init libs/config
        git submodule update --init libs/container
        python tools/boostdep/depinst/depinst.py container
        git submodule update --init libs/dynamic_bitset
        python tools/boostdep/depinst/depinst.py dynamic_bitset
        ./bootstrap.sh
        ./b2 headers
    - name: Check
      env:
        CXX: g++
        CXXFLAGS: --coverage -O0 -std=c++20 -I ../.dep/boost
      run: |
        make -j check
        make -j time
    - name: LCOV setup
      run: |
        sudo apt install lcov
    - name: Codecov setup
      run: |
        curl -Os https://uploader.codecov.io/latest/linux/codecov
        chmod +x codecov
    - name: Coverage
      run: |
        lcov -c -d .                                --rc lcov_branch_coverage=1 --rc geninfo_no_exception_branch=1 -o cov.info
        lcov -e cov.info '*/cxon/src/cxon/*.hxx'    --rc lcov_branch_coverage=1 --rc geninfo_no_exception_branch=1 -o cxon.info
        lcov                                        --rc lcov_branch_coverage=1 --rc geninfo_no_exception_branch=1 -l cxon.info
        ./codecov -t ${CODECOV_TOKEN} -f cxon.info
